# コンテナのベースイメージ
FROM node:22-bookworm-slim
LABEL maintainer='マグマ中山'

# アプリケーションディレクトリ名を環境変数に指定
ENV NODE_ROOT=node-app

# git postgresのインストール
RUN apt-get update && \
    apt-get install -y --no-install-recommends git vim postgresql-client && \
    apt-get clean && rm -rf /var/lib/apt/lists/* 

# 実行ユーザー追加
ARG USERNAME=node
ARG USER_UID=1000
ARG USER_GID=1000

# エイリアス生成
RUN echo 'alias server = "node server.js"' >> ~/.bashrc

# アプリケーションのディレクトリ作成
RUN mkdir -p /$NODE_ROOT/backend

# コンテナ起動時スクリプトの生成
RUN echo '#!/bin/sh' > /usr/local/bin/dockerInit.sh \
&& echo 'touch ./backend/yarn.lock && cd ./backend && yarn install && exec "$@" ' >> /usr/local/bin/dockerInit.sh \
# && echo 'alias server= "node server.js" >> ~/.bashrc'  >> /usr/local/bin/dockerInit.sh \
&& chmod +x /usr/local/bin/dockerInit.sh

# 作業ディレクトリ変更
WORKDIR /$NODE_ROOT

# アプリケーションファイルのコピー/権限変更
RUN chown $USERNAME:dialout /$NODE_ROOT/*

# コンテナのエントリポイントをdockerInit.shに設定する
ENTRYPOINT ["/usr/local/bin/dockerInit.sh"]
# CMD ["tail", "-f", "/dev/null"]
CMD ["npm", "run", "server"]